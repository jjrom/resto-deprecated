(function(d){d.R=d.R||{};d.R={VERSION_NUMBER:"RESTo 1.0",issuer:"getCollection",translation:{},restoUrl:null,layer:null,ssoServices:{},userProfile:null,userRights:null,init:function(a){var b,c=this,a=a||{};c.translation=a.translation||{};c.restoUrl=a.restoUrl;c.issuer=a.issuer;c.ssoServices=a.ssoServices||{};if(d.M&&($("#resto-container").bind("scroll",function(){clearTimeout(b);b=setTimeout(function(){d.M.events.trigger("resizeend")},150)}),a.data))var e=setInterval(function(){d.M.Map.map&&d.M.isLoaded&&
(c.initSearchLayer(a.data,!0),"getResource"===c.issuer&&c.layer&&(d.M.Map.zoomTo(c.layer.getDataExtent(),!1),c.userRights&&c.userRights.visualize&&$.isArray(a.data.features)&&a.data.features[0]&&a.data.features[0].properties.services.browse&&a.data.features[0].properties.services.browse.layer&&M.Map.addLayer({title:a.data.features[0].id,type:a.data.features[0].properties.services.browse.layer.type,layers:a.data.features[0].properties.services.browse.layer.layers,url:a.data.features[0].properties.services.browse.layer.url.replace("%5C",
"")})),(new M.Toolbar({position:"nw",orientation:"h"})).add({title:'<span class="fa fa-map-marker"></span>',tt:"Center",onoff:!1,onactivate:function(a,b){b.activate(!1);c.layer&&(c.layer.features&&0<c.layer.features.length)&&d.M.Map.zoomTo(c.layer.getDataExtent(),!1)}}),clearInterval(e))},500);if(d.M)var g=setInterval(function(){d.M.Map.map&&d.M.isLoaded&&(d.M.Map.events.register("moveend",c,function(a,c){c.updateBBOX()}),c.updateBBOX(),clearInterval(g))},500);$("#resto-searchform").submit(function(a){a.preventDefault();
d.History.pushState({randomize:d.Math.random()},null,"?"+$(this).serialize()+(d.M&&$("#mapshup").visible()?"&box="+d.M.Map.Util.p2d(M.Map.map.getExtent()).toBBOX():""))});$("#searchsubmit").click(function(a){a.preventDefault();$("#resto-searchform").submit()});c.updateRestoToolbar();c.Admin.updateAdminActions(a.collection);$("#search").focus();if("getCollection"===c.issuer)c.onHistoryChange(c.updateGetCollection);c.ajax({url:c.restoUrl+"auth/getProfile.php",dataType:"json",success:function(b){c.userProfile=
b;c.userRights=c.userProfile.collections&&c.userProfile.collections[c.collection]?$.extend(c.userProfile.rights["default"],c.userProfile.collections[c.collection]):c.userProfile.rights["default"];"getCollection"===c.issuer&&c.updateGetCollection(a.data,{updateMap:!1,centerMap:a.data&&a.data.query});c.updateConnectionInfo();c.hideMask()},error:function(){c.hideMask()}})},onHistoryChange:function(a){var b=this;d.History.Adapter.bind(d,"statechange",function(){var c=d.History.getState(),e=b.updateURL(c.cleanUrl,
{format:"json"});b.showMask();$.ajax({url:e,async:!0,dataType:"json",success:function(e){b.hideMask();"function"===typeof a&&a(e,{updateMap:!0,centerMap:c.data&&c.data.centerMap||e.query&&e.query.hasLocation?!0:!1})},error:function(){b.hideMask();b.message("Connection error")}})})},sanitizeValue:function(a){return!a||!a.length?"":("string"===$.type(a)?a:a.val()).replace(/<.*?>/g,"")},updateRestoToolbar:function(){var a=this;$(".shareOnFacebook").click(function(){d.open("https://www.facebook.com/sharer.php?u="+
encodeURIComponent(d.History.getState().cleanUrl)+"&t="+encodeURIComponent(a.sanitizeValue($("#search"))));return!1});$(".shareOnTwitter").click(function(){d.open("http://twitter.com/intent/tweet?status="+encodeURIComponent(a.sanitizeValue($("#search"))+" - "+d.History.getState().cleanUrl));return!1});$(".displayRSS").click(function(){d.location=a.updateURL(d.History.getState().cleanUrl,{format:"json"});return!1});$(".viewUserPanel").click(function(){a.showUserPanel()})},updateConnectionInfo:function(){this.isConnected()?
$(".viewUserPanel").html("").attr("title",this.userProfile.email).css("background-image","url("+this.getGravatar(this.userProfile.userhash,200)+")"):$(".viewUserPanel").html('<span class="fa fa-sign-in"></span>').attr("title",this.translate("_login")).css("background-image","auto")},showMask:function(){$('<div id="resto-mask-overlay"><span class="fa fa-3x fa-refresh fa-spin"></span></div>').appendTo($("body")).css({position:"fixed","z-index":"100000",top:"0px",left:"0px","background-color":"rgba(128, 128, 128, 0.7)",
color:"white","text-align":"center",width:"100%",height:"100%","line-height":$(d).height()+"px"}).show()},hideMask:function(){$("#resto-mask-overlay").remove()},translate:function(a,b){if(!this.translation||!this.translation[a])return a;var c,e,d=this.translation[a];if(b&&-1!==d.indexOf("{a:")){c=0;for(e=b.length;c<e;c++)d=d.replace("{a:"+(c+1)+"}",b[c])}return d},updateURL:function(a,b){var c,e,d,h,f,i={},j="",m=a.split("?")[0];try{f=a.split("?")[1].split("&")}catch(l){f=[]}d=0;for(h=f.length;d<
h;d++)c=f[d].split("=")[0],e=f[d].split("=")[1],c&&(i[c]=e?e:"");for(c in b)i[c]=b[c];for(c in i)j+=c+"="+i[c]+"&";return m+"?"+j},addLayer:function(a){if(!d.M)return null;"string"===typeof a&&(a=JSON.parse(decodeURI(a)));return d.M.Map.addLayer(a,{noDeletionCheck:!0})},initSearchLayer:function(a,b){this.layer=this.addLayer({type:"GeoJSON",clusterized:!1,data:a,zoomOnNew:b?"always":!1,MID:"__resto__",color:"#FFF1FB",selectable:"getCollection"===this.issuer?!0:!1,featureInfo:{noMenu:!0,onSelect:function(a){if(a&&
a.fid){d.M.Map.featureInfo.unhilite(d.M.Map.featureInfo.hilited);var b=0;0<$("#mapshup-tools").length&&(b=$("#mapshup-tools").position().top+$("#mapshup-tools").height());$(".resto-entry").each(function(){if($(this).attr("fid")===a.fid)return $(this).addClass("selected"),$("html, body").animate({scrollTop:$(this).offset().top-b},500),!1})}},onUnselect:function(){$(".resto-entry").each(function(){$(this).removeClass("selected")})}},ol:{styleMap:new OpenLayers.StyleMap({"default":new OpenLayers.Style(OpenLayers.Util.applyDefaults({fillOpacity:"getCollection"===
this.issuer?0.2:0.0010,strokeColor:"#ffff00",strokeWidth:1,fillColor:"#fff"})),select:{strokeColor:"#ffa500",fillOpacity:"getCollection"===this.issuer?0.7:0.0010}})}})},mimeToType:function(a){switch(a){case "application/json":return"GeoJSON";case "application/atom+xml":return"ATOM";case "text/html":return"HTML";default:return a}},updateBBOX:function(){var a;d.M&&d.M.Map.map&&($("#mapshup").visible()?(a=d.M.Map.Util.p2d(d.M.Map.map.getExtent()).toBBOX(),$(".resto-updatebbox").each(function(){$(this).attr("href",
d.M.Util.extendUrl($(this).attr("href"),{box:a}))})):$(".resto-updatebbox").each(function(){$(this).attr("href",d.M.Util.extendUrl($(this).attr("href"),{box:null}))}))},getResolution:function(a){return!$.isNumeric(a)?null:2.5>=a?"THR":2.5<a&&30>=a?"HR":30<a&&500>=a?"MR":"LR"},getGravatar:function(a,b){return"http://www.gravatar.com/avatar/"+(a?a:"")+"?d=mm"+(!b||!$.isNumeric(b)?"":"&s="+b)},ajax:function(a,b){var c=this;if("object"!==typeof a)return null;b&&(a.complete=function(){c.hideMask()},c.showMask());
return $.ajax(a)},message:function(a,b){var c=$("body"),e;c.append('<div class="adminMessage"><div class="content">'+a+"</div></div>");e=$(".adminMessage",c);e.fadeIn("slow").delay(b||2E3).fadeOut("slow",function(){e.remove()}).css({left:(c.width()-e.width())/2,top:60});return e},showUserPanel:function(){var a=this,b;b=$('<div id="restoUserPanel"><div class="close" title="'+a.translate("_close")+'"></div></div>').appendTo($("body")).show();$(".close",b).click(function(){a.hideUserPanel()});a.isConnected()?
a.displayProfile():a.displayLogin()},hideUserPanel:function(){$("#restoUserPanel").remove()},isConnected:function(){return this.userProfile&&this.userProfile.userid&&-1!==this.userProfile.userid?!0:!1},displayProfile:function(){var a=this;$("#restoUserPanel").append('<div class="row"><div class="large-12 columns"><img src="'+a.getGravatar(this.userProfile.userhash,200)+'"/><ul class="no-bullet"><li>'+a.userProfile.email+'</li></ul><a class="button signOut">'+a.translate("_logout")+"</a></div></div>");
$(".signOut").click(function(){a.showMask();a.ajax({url:a.restoUrl+"auth/disconnect.php",dataType:"json",success:function(){d.location.reload()},error:function(){a.hideMask();a.hideUserPanel();a.message("Error : cannot disconnect")}});return!1})},displayLogin:function(){var a,b=this,c=$("#restoUserPanel");$("#displayRegister").remove();c.append('<div class="row" id="displayLogin"><div class="large-12 columns"><form action="#"><ul class="no-bullet"><li><input id="userEmail" type="text" placeholder="'+
b.translate("_email")+'"/></li><li><input id="userPassword" type="password" placeholder="'+b.translate("_password")+'"/></li></ul><p><a class="button signIn">'+b.translate("_login")+'</a></p><div class="signWithOauth"></div><p><a class="register">'+b.translate("_createAccount")+"</a></p></form></div></div>");$("#userEmail").focus();$("#userPassword").keypress(function(a){if(13===a.which)return $(".signIn").trigger("click"),!1});$(".register").click(function(a){a.preventDefault();b.displayRegister();
return!1});$(".signIn").click(function(a){a.preventDefault();b.showMask();b.ajax({url:b.restoUrl+"auth/connect.php",headers:{Authorization:"Basic "+btoa(b.sanitizeValue($("#userEmail"))+":"+b.sanitizeValue($("#userPassword")))},dataType:"json",success:function(a){a&&-1===a.userid?(b.hideMask(),b.message("Error - unknown user or incorrect password")):d.location.reload()},error:function(){b.hideMask();b.message("Error - cannot sign in")}});return!1});for(a in b.ssoServices)(function(a){$(".signWithOauth").append('<p><a id="_oauth'+
a+'">'+b.translate("_signWithOauth",[a])+"</a></p>");$("#_oauth"+a).click(function(){var c=d.open(b.ssoServices[a].authorizeUrl,a,"dependent=yes, menubar=yes, toolbar=yes"),h=setInterval(function(){c.closed&&(clearInterval(h),d.location.reload())},200)})})(a)},displayRegister:function(){var a=this,b,c,e,g=$("#restoUserPanel");$("#displayLogin").remove();c='<li><input id="givenName" class="input-text" type="text" placeholder="'+a.translate("_givenName")+'"/></li><li><input id="lastName" class="input-text" type="text" placeholder="'+
a.translate("_lastName")+'"/></li><li><input id="userName" class="input-text" type="text" placeholder="'+a.translate("_userName")+'"/></li>';e='<li><input id="userEmail" class="input-text" type="text" placeholder="'+a.translate("_email")+'"/></li><li><input id="userPassword1" class="input-password" type="password" placeholder="'+a.translate("_password")+'"/></li><li><input id="userPassword2" class="input-password" type="password" placeholder="'+a.translate("_retypePassword")+'"/></li>';b='<p><a class="button register">'+
a.translate("_createAccount")+'</a></p><p><a class="signIn">'+a.translate("_back")+"</a></p>";g.append('<div class="row" id="displayRegister"><form class="nice" action="#"><div class="large-6 columns"><ul class="no-bullet">'+c+'</ul></div><div class="large-6 columns"><ul class="no-bullet">'+e+"</ul>"+b+"</div></form></div>");$("#givenName").focus();$("#userPassword2").keypress(function(a){if(13===a.which)return $(".register").trigger("click"),!1});$(".signIn").click(function(b){b.preventDefault();
a.displayLogin();return!1});$(".register").click(function(b){b.preventDefault();var b=a.sanitizeValue($("#userName")),c=a.sanitizeValue($("#userPassword1")),e=a.sanitizeValue($("#userPassword2")),g=a.sanitizeValue($("#userEmail"));if(!g||!a.isEmailAdress(g))return a.message("Email is not valid"),!1;if(!b)return a.message("Username is mandatory"),!1;if(!c||!e||c!==e)return a.message("Passwords differ"),!1;d.R.ajax({url:d.R.restoUrl+"auth/register.php",async:!0,type:"POST",dataType:"json",data:{email:g,
password:c,username:b,givenname:a.sanitizeValue($("#givenName")),lastname:a.sanitizeValue($("#lastName"))},success:function(b){b&&"OK"===b.status?(a.message(b.message),a.hideUserPanel()):a.message(b.ErrorMessage)},error:function(b){b.responseJSON?a.message(b.responseJSON.ErrorMessage):a.message("Error : cannot register")}},!0);return!1})},isEmailAdress:function(a){return!a||0===a.length?!1:/^[a-zA-Z0-9._-]+@[a-zA-Z0-9.-]+.[a-zA-Z]{2,4}$/.test(a)},updateGetCollection:function(a,b){var c,e,g=d.R,a=
a||{},b=b||{};d.M&&b.updateMap&&(g.layer?(g.layer.destroyFeatures(),d.M.Map.layerTypes.GeoJSON.load({data:a,layerDescription:g.layer._M.layerDescription,layer:g.layer,zoomOnNew:b.centerMap?"always":!1})):g.initSearchLayer(a,b.centerMap));0<$("#search").length&&$("#search").val(a.query?g.sanitizeValue(a.query.original.searchTerms):"");$("#resultsummary").html(g.translate("_resultFor",[a.query.original.searchTerms?'<font class="red">'+g.sanitizeValue(a.query.original.searchTerms)+"</font>":""]));if(a.query&&
a.query.real){c="";for(e in a.query.real)a.query.real[e]&&"language"!==e&&(c+="<b>"+e+"</b> "+a.query.real[e]+"</br>");c?$(".resto-queryanalyze").html('<div class="resto-query">'+c+"</div>"):$(".resto-queryanalyze").html('<div class="resto-query"><span class="resto-warning">'+g.translate("_notUnderstood")+"</span></div>")}else a.missing&&$(".resto-queryanalyze").html('<div class="resto-query"><span class="resto-warning">Missing mandatory search filters - '+a.missing.concat()+"</span></div>");g.updateGetCollectionResultEntries(a);
g.updateBBOX();$(".resto-ajaxified").each(function(){$(this).click(function(a){a.preventDefault();d.History.pushState({randomize:d.Math.random(),centerMap:$(this).hasClass("centerMap")},null,$(this).attr("href"))})})},updateGetCollectionResultEntries:function(a){var b,c,e,g,h,f,i,j,m,l,p,n,a=a||{},k=g=e=m=f="",q="#";if(a.missing)k="";else if(0===a.totalResults)k=this.translate("_noResult");else{if($.isArray(a.links)){b=0;for(c=a.links.length;b<c;b++)"first"===a.links[b].rel&&(f=' <a class="resto-ajaxified" href="'+
this.updateURL(a.links[b].href,{format:"html"})+'">'+this.translate("_firstPage")+"</a> "),"previous"===a.links[b].rel&&(m=' <a class="resto-ajaxified" href="'+this.updateURL(a.links[b].href,{format:"html"})+'">'+this.translate("_previousPage")+"</a> "),"next"===a.links[b].rel&&(e=' <a class="resto-ajaxified" href="'+this.updateURL(a.links[b].href,{format:"html"})+'">'+this.translate("_nextPage")+"</a> "),"last"===a.links[b].rel&&(g=' <a class="resto-ajaxified" href="'+this.updateURL(a.links[b].href,
{format:"html"})+'">'+this.translate("_lastPage")+"</a> "),"self"===a.links[b].rel&&(q=a.links[b].href)}1===a.totalResults?k+=this.translate("_oneResult",[a.totalResults]):1<a.totalResults&&(k+=this.translate("_multipleResult",[a.totalResults]));k+=a.startIndex?f+m+this.translate("_pagination",[a.startIndex,a.lastIndex])+e+g:""}$(".resto-pagination").each(function(){$(this).html(k)});m=$(".resto-content").empty();b=0;for(c=a.features.length;b<c;b++){f=a.features[b];h=f.properties.thumbnail||f.properties.quicklook||
this.restoUrl+"/css/default/img/noimage.png";j=f.properties.platform;f.properties.keywords&&f.properties.keywords[f.properties.platform]&&(j='<a href="'+this.updateURL(f.properties.keywords[f.properties.platform].href,{format:"html"})+'" class="resto-ajaxified resto-updatebbox resto-keyword resto-keyword-platform" title="'+this.translate("_thisResourceWasAcquiredBy",[f.properties.platform])+'">'+f.properties.platform+"</a> ");l="#";if($.isArray(f.properties.links)){e=0;for(g=f.properties.links.length;e<
g;e++)"text/html"===f.properties.links[e].type&&(l=f.properties.links[e].href)}m.append('<li><div class="resto-entry" id="rid'+b+'" fid="'+f.id+'"><div class="padded-bottom"><span class="platform">'+j+(j&&f.properties.instrument?"/"+f.properties.instrument:"")+'</span> | <span class="timestamp">'+f.properties.startDate+'</span></div><div><a href="'+l+'" title="'+this.translate("_viewMetadata",[f.id])+'"><img class="resto-image" src="'+h+'"/></a></div><div class="resto-actions"></div><div class="resto-keywords"></div></div></li>');
e=$(".resto-actions",$("#rid"+b));e.append('<a class="fa fa-map-marker showOnMap" href="#" title="'+this.translate("_showOnMap")+'"></a>');f.properties.services&&f.properties.services.download&&f.properties.services.download.url&&this.userRights&&this.userRights.download&&e.append('<a class="fa fa-cloud-download" href="'+f.properties.services.download.url+'"'+("text/html"===f.properties.services.download.mimeType?' target="_blank"':"")+' title="'+this.translate("_download")+'"></a>');(function(a){$(".showOnMap",
a).click(function(b){b.preventDefault();if(b=d.M.Map.Util.getFeature(d.M.Map.Util.getLayerByMID("__resto__"),a.attr("fid")))d.M.Map.zoomTo(b.geometry.getBounds(),!1),d.M.Map.featureInfo.hilite(b),$(".resto-entry").each(function(){$(this).removeClass("selected")}),a.addClass("selected"),$("html, body").animate({scrollTop:$("#mapshup").offset().top-50},500)})})($("#rid"+b));if(f.properties.keywords){g=[];e={landuse:{title:"_landUse",keywords:[]},location:{title:"_location",keywords:[]},tag:{title:"_tags",
keywords:[]},resolution:{title:"_resolution",keywords:[]},other:{title:"_other",keywords:[]}};for(i in f.properties.keywords){h=f.properties.keywords[i];l=i;p="";n=null;if("landuse"===h.type)j="landuse",l=l+" ("+Math.round(h.value)+"%)",n=" resto-updatebbox resto-keyword-"+h.id,p=this.translate("_thisResourceContainsLanduse",[h.value,i]);else if("country"===h.type||"continent"===h.type)j="location",n=" centerMap",p=this.translate("_thisResourceIsLocated",[i]);else if("city"===h.type)j="location",
n=" centerMap",p=this.translate("_thisResourceContainsCity",[i]);else if("platform"===h.type||"instrument"===h.type)continue;else if("date"===h.type)continue;else j=0===i.indexOf("#")?"tag":"other",n=" resto-updatebbox";e[j].keywords.push('<a href="'+this.updateURL(f.properties.keywords[i].href,{format:"html"})+'" class="resto-ajaxified resto-keyword'+(f.properties.keywords[i].type?" resto-keyword-"+f.properties.keywords[i].type.replace(" ",""):"")+(n?n:"")+'" title="'+p+'">'+l+"</a> ")}f.properties.resolution&&
(h=this.getResolution(f.properties.resolution),e.resolution.keywords.push(f.properties.resolution+'m - <a href="'+this.updateURL(q,{q:this.translate(h),format:"html"})+'" class="resto-ajaxified resto-updatebbox resto-keyword resto-keyword-resolution" title="'+this.translate(h)+'">'+h+"</a>"));for(i in e)0<e[i].keywords.length&&g.push('<td class="title">'+this.translate(e[i].title)+'</td><td class="values">'+e[i].keywords.join(", ")+"</td>");$(".resto-keywords",$("#rid"+b)).html("<table>"+g.join("</tr>")+
"</table>")}}}};d.R.Admin={updateAdminActions:function(a){var b=this;$(".deactiveCollection").each(function(){$(this).click(function(a){a.stopPropagation();b.removeCollection($(this).attr("collection"),!1);return!1})});$(".removeCollection").each(function(){$(this).click(function(a){a.stopPropagation();b.removeCollection($(this).attr("collection"),!0);return!1})});$(".updateCollection").each(function(){$(this).click(function(a){a.stopPropagation();b.updateCollection($(this).attr("collection"));return!1})});
var c=$("#dropZone");c.bind("dragleave",function(a){c.removeClass("hover");a.preventDefault();a.stopPropagation()}).bind("dragover",function(a){c.addClass("hover");a.preventDefault();a.stopPropagation()}).bind("drop",function(e){c.removeClass("hover");e.preventDefault();e.stopPropagation();var e=e.originalEvent.dataTransfer.files,g=$(this).hasClass("_dropCollection")?"collection":"resource";if(0===e.length)d.R.message("Error : drop a file");else if(1<e.length)d.R.message("Error : drop only one file at a time");
else{var h=new FileReader;h.onloadend=function(c){try{"collection"===g?b.addCollection($.parseJSON(c.target.result)):b.addResource($.parseJSON(c.target.result),a)}catch(e){"collection"===g?d.R.message("Error : collection description is not valid JSON"):d.R.message("Error : resource file is not valid")}};h.readAsText(e[0])}})},addCollection:function(a){d.confirm("Add collection "+a.name+" ?")&&d.R.ajax({url:d.R.restoUrl,async:!0,type:"POST",dataType:"json",data:{data:encodeURIComponent(JSON.stringify(a))},
success:function(a,c,e){200===e.status?d.location=d.R.restoUrl:d.R.message(c)},error:function(a){d.R.message(a.responseJSON.ErrorMessage)}},!0)},addResource:function(a,b){if(!b||!a)return!1;d.confirm("Add resource to collection "+b+" ?")&&d.R.ajax({url:d.R.restoUrl+"/"+b+"/",async:!0,type:"POST",dataType:"json",data:{data:encodeURIComponent(JSON.stringify(a))},success:function(a,b,g){200===g.status?d.R.message("Resource added"):d.R.message(b)},error:function(a){d.R.message(a.responseJSON.ErrorMessage)}},
!0);return!0},removeCollection:function(a,b){d.confirm("Remove collection "+a+" ?")&&d.R.ajax({url:d.R.restoUrl+a+(b?"?physical=true":""),async:!0,type:"DELETE",dataType:"json",success:function(b,e,g){200===g.status?(d.R.message(b.Message),$("#_"+a).fadeOut(300,function(){$(this).remove()})):alert(e)},error:function(a){alert(a.responseJSON.ErrorMessage)}},!0)},updateCollection:function(){}}})(window);
